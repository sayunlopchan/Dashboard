<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <link rel="stylesheet" href="/frontend/css/form.css">
  </head>

  <body>
    <form id="signupForm">
      <h2>Let's create your account!</h2>
      <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Delectus, accusamus.</p>

      <div class="form-error" id="form-error"></div>

      <div class="input-box">
        <input type="text" id="signup-username" placeholder="Enter your username" required>
        <span class="error-message" id="username-error"></span>
      </div>
      <div class="input-box">
        <input type="email" id="signup-email" placeholder="Enter your email" required>
        <span class="error-message" id="email-error"></span>
      </div>
      <div class="input-box">
        <input type="password" id="signup-password" placeholder="Enter your password" required>
        <span class="error-message" id="password-error"></span>
      </div>
      <div class="input-box">
        <input type="password" id="signup-confirm-password" placeholder="Confirm password" required>
        <span class="error-message" id="confirm-password-error"></span>
      </div>

      <div class="login-footer">
        <button class="btn-fill" type="submit" id="signup-button">Sign up</button>
        <p>Already have an account? <a href="/login">Login</a></p>
      </div>
    </form>

    <script>
      // DOM Elements
      const signupForm = document.getElementById('signupForm');
      const usernameInput = document.getElementById('signup-username');
      const emailInput = document.getElementById('signup-email');
      const passwordInput = document.getElementById('signup-password');
      const confirmPasswordInput = document.getElementById('signup-confirm-password');
      const usernameError = document.getElementById('username-error');
      const emailError = document.getElementById('email-error');
      const passwordError = document.getElementById('password-error');
      const confirmPasswordError = document.getElementById('confirm-password-error');
      const formError = document.getElementById('form-error');
      const signupButton = document.getElementById('signup-button');

      // Form submission handler
      signupForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Reset error messages
        usernameError.textContent = '';
        emailError.textContent = '';
        passwordError.textContent = '';
        confirmPasswordError.textContent = '';
        formError.style.display = 'none';

        // Get form values
        const username = usernameInput.value.trim();
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();

        // Client-side validation
        let isValid = true;

        // Username validation
        if (!username) {
          usernameError.textContent = 'Username is required';
          isValid = false;
        } else if (username.length < 3) {
          usernameError.textContent = 'Username must be at least 3 characters';
          isValid = false;
        }

        // Email validation
        if (!email) {
          emailError.textContent = 'Email is required';
          isValid = false;
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          emailError.textContent = 'Please enter a valid email address';
          isValid = false;
        }

        // Password validation
        if (!password) {
          passwordError.textContent = 'Password is required';
          isValid = false;
        } else if (password.length < 6) {
          passwordError.textContent = 'Password must be at least 6 characters';
          isValid = false;
        }

        // Confirm password validation
        if (!confirmPassword) {
          confirmPasswordError.textContent = 'Please confirm your password';
          isValid = false;
        } else if (password !== confirmPassword) {
          confirmPasswordError.textContent = 'Passwords do not match';
          isValid = false;
        }

        if (!isValid) return;

        try {
          // Disable button during request
          signupButton.disabled = true;
          signupButton.textContent = 'Creating account...';

          // Call signup API
          const response = await fetch('/api/auth/signup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, email, password })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Signup failed');
          }

          // Signup successful - redirect to login page with success message
          window.location.href = '/login?signup=success';

        } catch (error) {
          console.error('Signup error:', error);

          // Use generic message to prevent user enumeration
          formError.textContent = 'Invalid credentials.';
          formError.style.display = 'block';
        } finally {
          // Re-enable button
          signupButton.disabled = false;
          signupButton.textContent = 'Sign up';
        }
      });

      // Check for success message in URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('signup') === 'success') {
        formError.style.display = 'block';
        formError.style.color = '#4CAF50';
        formError.textContent = 'Account created successfully! Please login.';
      }
    </script>

  </body>

</html>