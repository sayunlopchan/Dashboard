<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="/frontend/css/form.css">
    <style>
      .error-message {
        color: #ff4444;
        font-size: 0.8rem;
        margin-top: 0.25rem;
        display: block;
      }

      .form-error {
        color: #ff4444;
        text-align: center;
        margin-bottom: 1rem;
        display: none;
      }
    </style>
  </head>

  <body>
    <form id="loginForm">
      <h2>Admin Login</h2>
      <p>Please enter your admin credentials to access the dashboard</p>

      <div class="form-error" id="form-error"></div>

      <div class="input-box">
        <input type="email" id="login-email" placeholder="Enter admin email" required>
        <span class="error-message" id="email-error"></span>
      </div>
      <div class="input-box">
        <input type="password" id="login-password" placeholder="Enter your password" required>
        <span class="error-message" id="password-error"></span>
      </div>

      <div class="login-footer">
        <button class="btn-fill" type="submit" id="login-button">Login</button>
        <p>For regular users, please <a href="/">return to homepage</a></p>
      </div>

      <div class="form-img-container">
        <img src="/frontend/assets/textures/gym-graphic.svg" alt="gym-graphic">
      </div>
    </form>

    <script>
      // DOM Elements
      const loginForm = document.getElementById('loginForm');
      const emailInput = document.getElementById('login-email');
      const passwordInput = document.getElementById('login-password');
      const emailError = document.getElementById('email-error');
      const passwordError = document.getElementById('password-error');
      const formError = document.getElementById('form-error');
      const loginButton = document.getElementById('login-button');

      // Form submission handler
      loginForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Reset error messages
        emailError.textContent = '';
        passwordError.textContent = '';
        formError.style.display = 'none';

        // Get form values
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        // Basic client-side validation
        let isValid = true;

        if (!email) {
          emailError.textContent = 'Email is required';
          isValid = false;
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          emailError.textContent = 'Please enter a valid email address';
          isValid = false;
        }

        if (!password) {
          passwordError.textContent = 'Password is required';
          isValid = false;
        } else if (password.length < 6) {
          passwordError.textContent = 'Password must be at least 6 characters';
          isValid = false;
        }

        if (!isValid) return;

        try {
          // Disable button during request
          loginButton.disabled = true;
          loginButton.textContent = 'Logging in...';

          // Call login API
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password }),
            credentials: 'include' // Important for cookies
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Login failed');
          }

          // Login successful - redirect to admin dashboard
          window.location.href = '/admin/dashboard';

        } catch (error) {
          console.error('Login error:', error);
          formError.textContent = error.message || 'Login failed. Please try again.';
          formError.style.display = 'block';

          // Special handling for admin access error
          if (error.message.includes('Admin only')) {
            formError.textContent = 'Access denied. Admin credentials required.';
          }
        } finally {
          // Re-enable button
          loginButton.disabled = false;
          loginButton.textContent = 'Login';
        }
      });

      // Check if user is already logged in
      async function checkAuthStatus() {
        try {
          const response = await fetch('/api/auth/verify-token', {
            credentials: 'include'
          });

          const data = await response.json();

          if (data.valid) {
            // User is already authenticated - redirect to dashboard
            window.location.href = '/admin/dashboard';
          }
        } catch (error) {
          console.log('Not authenticated:', error);
        }
      }

      // Run auth check when page loads
      checkAuthStatus();
    </script>
  </body>

</html>